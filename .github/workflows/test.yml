name: Preview

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - name: üèó Setup repo
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: üèó Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20.x
          cache: npm
      - name: üèó Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      - name: üì¶ Install dependencies
        run: npm install
      - name: üöÄ Create preview
        uses: expo/expo-github-action/preview@v8
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          command: eas update --auto --branch ${{ github.head_ref }}
          comment: false
          qr-code: 'expo-go'

      - name: üí¨ Comment PR
        uses: thollander/actions-comment-pull-request@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          comment_tag: execution
          message: |
            üöÄ Expo preview is ready!
            - Project ‚Üí **${{ steps.preview.outputs.projectName }}**
            - Platforms ‚Üí **${{ steps.preview.outputs.platforms }}**
            - Runtime Version ‚Üí **${{ steps.preview.outputs.runtimeVersion }}**
            - **[More info](${{ steps.preview.outputs.projectLink }})**

            > Learn more about [ùù† Expo Github Action](https://github.com/expo/expo-github-action/tree/main/preview#example-workflows)

            <details>
            <summary>Additional Information</summary>

            - Project Owner: `${{ steps.preview.outputs.projectOwner }}`
            - Project Slug: `${{ steps.preview.outputs.projectSlug }}`
            - Project Deep Link: `${{ steps.preview.outputs.projectDeepLink }}`
            - Project QR: `${{ steps.preview.outputs.projectQR }}`
            - Channel: `${{ steps.preview.outputs.channel }}`
            - Message: `${{ steps.preview.outputs.message }}`
            - Message ID: `${{ steps.preview.outputs.messageId }}`
            </details>
